defaults: &defaults
  working_directory: '~/project'
  docker:
    - image: node:8.9.4

persist_workspace: &persist_workspace
  persist_to_workspace:
    root: '.'
    paths: [ '.' ]

attach_workspace: &attach_workspace
  attach_workspace:
    at: '.'

#########################JOBS#########################################
version: 2
jobs:
  checkout:
    <<: *defaults
    steps:
      - restore_cache:
          keys:
            - v1-{{ .Environment.CIRCLE_SHA1 }}
            - v1
      - checkout
      - save_cache:
          key: v1-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ".git"
      - *persist_workspace

  install_dependencies:
    <<: *defaults
    steps:
      - *attach_workspace
      - run:
          name: 'Install yarn'
          command: |
            curl -o- -L https://yarnpkg.com/install.sh | bash
      - restore_cache:
          keys:
            - dependencies-{{ .Branch }}-{{ checksum "yarn.lock" }}-{{ checksum "rocket-api/yarn.lock" }}-{{ checksum "mock-api/yarn.lock"}}
            - dependencies-{{ .Branch }}-{{ checksum "yarn.lock" }}-{{ checksum "rocket-api/yarn.lock" }}
            - dependencies-{{ .Branch }}-{{ checksum "yarn.lock" }}
            - dependencies-{{ .Branch }}
            - dependencies
      - run:
          name: 'Install dependencies'
          command: |
            yarn add lerna -D
            yarn run bootstrap

      - save_cache:
          key: dependencies-{{ .Branch }}-{{ checksum "yarn.lock" }}-{{ checksum "rocket-api/yarn.lock" }}-{{ checksum "mock-api/yarn.lock"}}
          paths:
            - node_modules
            - rocket-api/node_modules
            - mock-api/node_modules

  echo:
    <<: *defaults
    steps:
      - run:
          name: 'echo helloworld'
          command:
            echo 'hello world'

############################WORKFLOWS###################################
workflows:
  version: 2

  pipeline:
    jobs:
      - checkout
      - install_dependencies:
          requires: ['checkout']